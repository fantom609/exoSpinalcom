<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>occupancy dashboard</title>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
</head>
<body>

    <div id="app">
        <div class="background">
            <h1 class="title">Analyse de l'occupation</h1>
            <div class="container">
                <div class="list">
                    <h2>Batiments</h2>

                    <div class="card" v-for="space in spaces">
                        <button class="button" @click="getFloors(space)">
                            {{ space.name }}
                        </button>
                    </div>
                </div>

                <div class="list">
                    <h2>Etages</h2>

                    <div class="card" v-for="floor in floors">
                        <button class="button" @click="updaterooms(floor)">
                            {{ floor.name }}
                        </button>
                    </div>
                </div>

                <div class="list">
                    <h2>Piéces</h2>

                    <div class="card-rooms" v-for="room in rooms">
                        <p class="room-name">{{ room.name }}</p>
                        <p class="badge occupied" v-if="room.occupation === true">Occupé</p>
                        <p class="badge free" v-else-if="room.occupation === false">Disponible</p>
                        <p class="badge undefined" v-else>Indeterminé</p>
                    </div>
                </div>
            </div>
        </div>

    </div>


<script>
    var app = new Vue({
        el:'#app',
        data: {
            spaces: [],
            floors: [],
            rooms: []
        },
        methods: {
            async getSpaces() {
                try {
                    const response = await axios.get('https://api-developers.spinalcom.com/api/v1/geographicContext/space')
                    console.log(response)
                    this.spaces = response.data.children
                } catch {
                    console.log("error lors de la récupération des espaces")
                }
            },
            async getFloors(space) {
                this.floors = []
                try {
                    for (const room of space.children) {
                        const promises = [];
                        for (const r of room.children) {
                            const promise = axios.get(`https://api-developers.spinalcom.com/api/v1/room/${r.dynamicId}/control_endpoint_list`)
                                .then(response => {
                                    if (response.data[0]) {
                                        response.data[0].endpoints.forEach(e => {
                                            r[e.type.toLowerCase()] = e.currentValue;
                                        });
                                    }
                                    return r;
                                });
                            promises.push(promise);
                        }
                        room.children = await Promise.all(promises);
                        this.floors.push(room);
                    }
                } catch {
                    console.log("error")
                }
                this.floors = space.children
            },
            async updaterooms(floor) {
                this.rooms = floor.children
            },
        },

        mounted() {
            this.getSpaces()
        }
    })
</script>

<style>

    .background {
        background-color: #EEF4F4;
        border-radius: 8px;
        margin-inline: 8%;
        padding: 4px;
        margin-top: 24px;
    }

    .title {
        text-align: center;
    }

    .container {
        display: flex;
        padding: 16px;
        height: 80vh;
    }

    .list {
        overflow-y: auto;
        max-height: 100%;
        margin: 12px;
        display: flex;
        flex-direction: column;
        width: 33%;
        align-content: center;
        align-items: center;
        justify-content: flex-start;
        background-color: #F8FAF9;
        box-shadow: rgba(0, 0, 0, 0.15) 3px 3px 4px;
        border-radius: 8px;
    }

    .card {
        display: flex;
        height: 80px;
        border-radius: 8px;
        margin-top: 6px;
        margin-bottom: 6px;
        justify-content: space-between;
        padding: 8px;
        width: 90%;
    }

    .button {
        width: 100%;
        margin: 16px;
        border-radius: 8px;
        font-size: 20px;
        border: none;
        box-shadow: rgba(0, 0, 0, 0.15) 3px 3px 4px;
    }

    .badge {
        padding: 8px;
        box-shadow: rgba(0, 0, 0, 0.15) 2px 2px 4px;
        color: white;
        border-radius: 4px;
        margin: 0;
        display: flex;
        height: 24px;
        flex-direction: column;
        justify-content: center
    }

    .card-rooms {
        display: flex;
        width: 90%;
        min-height: 60px;
        border-radius: 8px;
        box-shadow: rgba(0, 0, 0, 0.15) 3px 3px 4px;
        margin-top: 6px;
        margin-bottom: 6px;
        padding: 16px;
        justify-content: space-between;
        background-color: #f0f0f3;
        align-items: center;
        font-size: 18px;
    }

    .occupied {
        background-color: #015b01;
    }

    .free {
        background-color: #a60a0a;
    }

    .undefined {
        background-color: #070762;
    }


</style>
</body>
</html>